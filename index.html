<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ржорж╛ржзржмржо ржкржЮрзНржЬрж┐ржХрж╛ v5.4 тАФ Live</title>
<style>
  :root{
    --pink:#E84EB4;       /* Bengali panjika pink */
    --red:#B71C1C;        /* Ekadashi panel */
    --header:#FFE082;     /* All headings */
    --label:#FF6F00;      /* ЁЯФе Orange labels (bold) */
    --value:#000000;      /* Deep black values */
  }
  body{ margin:0;background:#FFF8E1;
        font-family:'Noto Sans Bengali','Noto Serif Bengali',sans-serif;
        display:flex;justify-content:center; }
  .wrap{ width:100%;max-width:420px;margin:10px auto;padding:6px;box-sizing:border-box; }
  .card{ border-radius:14px;margin:3px 0;padding:10px;color:#000;
         border:1px solid rgba(255,255,255,0.7); box-shadow:0 2px 8px rgba(0,0,0,0.2); }
  .title{ text-align:center;font-weight:800;font-size:18px;color:var(--header);margin:0 0 8px; }
  .subgrid{ display:grid;grid-template-columns:1fr 1fr;gap:8px; }
  .subcard{ background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.4);
            border-radius:8px;padding:6px 8px; }
  .label{ font-size:13px;font-weight:700;color:var(--label); }
  .value{ font-size:15px;font-weight:800;color:var(--value);margin-top:2px; }
  .status{ font-size:11px;color:#ffffff;margin-top:8px;text-align:center;opacity:.95; }
  .btn{ display:block;width:100%;text-align:center;border-radius:10px;padding:10px 12px;
        border:1px solid rgba(255,255,255,0.7);background:rgba(255,255,255,0.12);
        font-weight:700;color:#000;cursor:pointer;transition:filter .15s ease; }
  .hover-light:hover{ filter:brightness(1.1); }
  .eka-name{ font-size:30px;line-height:1.1;font-weight:800;color:#fff; }
  .eka-sub{ font-size:14px;color:#FFEB3B;margin-top:4px; }
  /* Popup */
  .modal{ position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;
          align-items:center;justify-content:center;z-index:9999; }
  .modal.active{ display:flex; }
  .modal-box{ width:min(92vw,480px);max-height:80vh;overflow:auto;background:#fff;
              border-radius:16px;padding:16px;color:#4E342E;box-shadow:0 20px 50px rgba(0,0,0,.45); }
  .modal-title{ font-weight:800;color:#6A1B9A;text-align:center;margin-bottom:8px; }
  .modal-close{ display:block;margin:10px auto 0 auto;width:max-content;cursor:pointer;
                padding:6px 12px;border-radius:8px;border:1px solid #6A1B9A;color:#6A1B9A;font-weight:700; }
</style>
</head>
<body>
<div class="wrap">

  <!-- PANEL 1: PANCHIKA (Pink) -->
  <section class="card" style="background:var(--pink);">
    <h3 class="title">ЁЯкФ ржкржЮрзНржЬрж┐ржХрж╛</h3>
    <div class="subgrid">
      <div class="subcard"><div class="label">рждрж┐ржерж┐</div><div class="value" id="tithi">рж▓рзЛржб рж╣ржЪрзНржЫрзЗтАж</div></div>
      <div class="subcard"><div class="label">ржиржХрзНрж╖рждрзНрж░</div><div class="value" id="nakshatra">рж▓рзЛржб рж╣ржЪрзНржЫрзЗтАж</div></div>
      <div class="subcard"><div class="label">рж╕рзВрж░рзНржпрзЛржжржпрж╝</div><div class="value" id="sunrise">тАФ</div></div>
      <div class="subcard"><div class="label">рж╕рзВрж░рзНржпрж╛рж╕рзНржд</div><div class="value" id="sunset">тАФ</div></div>
      <div class="subcard"><div class="label">ржЪржирзНржжрзНрж░рзЛржжржпрж╝</div><div class="value" id="moonrise">тАФ</div></div>
      <div class="subcard"><div class="label">ржЪржирзНржжрзНрж░рж╛рж╕рзНржд</div><div class="value" id="moonset">тАФ</div></div>
    </div>
    <div class="status" id="panchika-status">рж╕рзВрж░рзНржпрж╕рж┐ржжрзНржзрж╛ржирзНржд Sync рж╕ржХрзНрж░рж┐ржпрж╝ ┬╖ ржкрзНрж░рждрж┐ рзй ржШржгрзНржЯрж╛ржпрж╝ ржЖржкржбрзЗржЯ</div>
  </section>

  <!-- PANEL 2: FULL PANJIKA TRIGGER (Pink + hover lighten) -->
  <section class="card hover-light" style="background:var(--pink);">
    <h3 class="title">ЁЯУЕ рж╕ржорзНржкрзВрж░рзНржг ржкржЮрзНржЬрж┐ржХрж╛</h3>
    <div class="btn" id="openPopup">рж╕ржорзНржкрзВрж░рзНржг рж╣рж┐ржирзНржжрзБ ржкржЮрзНржЬрж┐ржХрж╛ ржХрзНржпрж╛рж▓рзЗржирзНржбрж╛рж░ ржжрзЗржЦрзБржи</div>
  </section>

  <!-- PANEL 3: EKADASHI TRACKER (Deep Red) -->
  <section class="card" style="background:var(--red);color:#fff;">
    <h3 class="title">ЁЯМ╝ ржПржХрж╛ржжрж╢рзА ржЯрзНрж░рзНржпрж╛ржХрж╛рж░</h3>
    <div style="text-align:center;">
      <div class="eka-name" id="ekaName">рж▓рзЛржб рж╣ржЪрзНржЫрзЗтАж</div>
      <div class="eka-sub" id="ekaSub">тАФ</div>
    </div>
  </section>

</div>

<!-- Popup shell (placeholder for monthly view; trigger works) -->
<div class="modal" id="popup">
  <div class="modal-box">
    <div class="modal-title">ЁЯУЕ рж╕ржорзНржкрзВрж░рзНржг ржкржЮрзНржЬрж┐ржХрж╛ тАФ ржбрзЗржорзЛ ржнрж┐ржЙ</div>
    <div style="text-align:center;opacity:.8">ржПржЦрж╛ржирзЗ ржорж╛рж╕рж┐ржХ ржХрзНржпрж╛рж▓рзЗржирзНржбрж╛рж░/рждрж┐ржерж┐/ржЙрзОрж╕ржм рж░рзЗржирзНржбрж╛рж░ рж╣ржмрзЗред</div>
    <span class="modal-close" id="closePopup">ржмржирзНржз ржХрж░рзБржи</span>
  </div>
</div>

<script>
/* =========================
   GEO: GPS тЖТ IP тЖТ Default
========================= */
const DEF = { name:'Garden Reach, Kolkata', lat:22.533, lon:88.310, tz:'auto' };
let GEO = {...DEF};

function getGPS(){
  return new Promise(res=>{
    if(!navigator.geolocation) return res(null);
    navigator.geolocation.getCurrentPosition(
      p=>res({lat:p.coords.latitude, lon:p.coords.longitude}),
      _=>res(null), {enableHighAccuracy:true, timeout:6000, maximumAge:60000}
    );
  });
}
async function getIP(){
  try{
    const r=await fetch('https://ipapi.co/json/'); const j=await r.json();
    if(j && j.latitude && j.longitude){ return {lat:j.latitude, lon:j.longitude}; }
  }catch(e){}
  return null;
}

/* =========================
   SUN/MOON from Open-Meteo
========================= */
async function loadSunMoon(){
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${GEO.lat}&longitude=${GEO.lon}&daily=sunrise,sunset,moonrise,moonset&timezone=${GEO.tz}`;
    const r=await fetch(url); const d=await r.json();
    const t=s=>s? (s.split('T')[1]||s).slice(0,5) : 'тАФ';
    document.getElementById('sunrise').textContent=t(d.daily.sunrise?.[0]);
    document.getElementById('sunset').textContent =t(d.daily.sunset ?. [0]);
    document.getElementById('moonrise').textContent=t(d.daily.moonrise?.[0]);
    document.getElementById('moonset').textContent =t(d.daily.moonset ?. [0]);
    document.getElementById('panchika-status').textContent='рж╕рзВрж░рзНржп/ржЪржирзНржжрзНрж░ рж╕ржоржпрж╝ тАФ Open-Meteo рж▓рж╛ржЗржн';
  }catch(e){
    document.getElementById('panchika-status').textContent='рж╕рзВрж░рзНржп/ржЪржирзНржжрзНрж░ ржбрзЗржЯрж╛ ржЖржирждрзЗ ржкрж╛рж░рж┐ржирж┐';
  }
}

/* =========================================
   CORE ASTRONOMY (Tithi & Nakshatra, no API)
   тАФ low-accuracy Meeus-style approximations
========================================= */
const D2R = Math.PI/180, R2D = 180/Math.PI;
const NAK = ['ржЕрж╢рзНржмрж┐ржирзА','ржнрж░ржгрзА','ржХрзГрждрзНрждрж┐ржХрж╛','рж░рзЛрж╣рж┐ржгрзА','ржорзГржЧрж╢рж┐рж░рж╛','ржЖржжрзНрж░рж╛','ржкрзБржирж░рзНржмрж╕рзБ','ржкрзБрж╖рзНржпрж╛','ржЕрж╢рзНрж▓рзЗрж╖рж╛','ржоржШрж╛','ржкрзВрж░рзНржмрж╛ ржлрж╛рж▓рзНржЧрзБржирзА','ржЙрждрзНрждрж░рж╛ ржлрж╛рж▓рзНржЧрзБржирзА','рж╣рж╕рзНрждрж╛','ржЪрж┐рждрзНрж░рж╛','рж╕рзНржмрж╛рждрзА','ржмрж┐рж╢рж╛ржЦрж╛','ржЕржирзБрж░рж╛ржзрж╛','ржЬрзНржпрзЗрж╖рзНржарж╛','ржорзВрж▓рж╛','ржкрзВрж░рзНржмрж╛рж╖рж╛рзЭрж╛','ржЙрждрзНрждрж░рж╛рж╖рж╛рзЭрж╛','рж╢рзНрж░ржмржг','ржзржирж┐рж╖рзНржарж╛','рж╢рждржнрж┐рж╖рж╛','ржкрзВрж░рзНржмржнрж╛ржжрзНрж░','ржЙрждрзНрждрж░ржнрж╛ржжрзНрж░','рж░рзЗржмрждрзА'];

function jdFromDate(date){
  // UTC JD
  const t = Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(),
                     date.getUTCHours(), date.getUTCMinutes(), date.getUTCSeconds())/86400000 + 2440587.5;
  return t;
}
function norm360(x){ x%=360; return x<0?x+360:x; }

function sunEclLon(d){ // d = days since J2000 (UTC)
  const L = 280.459 + 0.98564736*d;
  const g = (357.529 + 0.98560028*d)*D2R;
  const lam = L + 1.915*Math.sin(g) + 0.020*Math.sin(2*g);
  return norm360(lam);
}
function moonEclLon(d){
  // Mean elements
  const Lm = 218.316 + 13.176396*d;             // mean longitude
  const Mm = (134.963 + 13.064993*d)*D2R;       // mean anomaly
  const D  = (297.850 + 12.190749*d)*D2R;       // elongation
  const F  = (93.272  + 13.229350*d)*D2R;       // argument of latitude
  let lon = Lm
    + 6.289*Math.sin(Mm)
    + 1.274*Math.sin(2*D - Mm)
    + 0.658*Math.sin(2*D)
    + 0.214*Math.sin(2*Mm)
    + 0.110*Math.sin(D);
  return norm360(lon);
}
function nowD(){ return (jdFromDate(new Date()) - 2451545.0); }

function calcTithiNak(date){
  const d = (jdFromDate(date) - 2451545.0);
  const sun = sunEclLon(d);
  const moon = moonEclLon(d);
  const elong = norm360(moon - sun);                // Moon-Sun angle
  const tithiNum = Math.floor(elong/12) + 1;        // 1..30
  const tithiNames = ['ржкрзНрж░рждрж┐ржкржж','ржжрзНржмрж┐рждрзАрзЯрж╛','рждрзГрждрзАрзЯрж╛','ржЪрждрзБрж░рзНржерзА','ржкржЮрзНржЪржорзА','рж╖рж╖рзНржарзА','рж╕ржкрзНрждржорзА','ржЕрж╖рзНржЯржорзА','ржиржмржорзА','ржжрж╢ржорзА','ржПржХрж╛ржжрж╢рзА','ржжрзНржмрж╛ржжрж╢рзА','рждрзНрж░ржпрж╝рзЛржжрж╢рзА','ржЪрждрзБрж░рзНржжрж╢рзА','ржкрзВрж░рзНржгрж┐ржорж╛','ржкрзНрж░рждрж┐ржкржж','ржжрзНржмрж┐рждрзАрзЯрж╛','рждрзГрждрзАрзЯрж╛','ржЪрждрзБрж░рзНржерзА','ржкржЮрзНржЪржорзА','рж╖рж╖рзНржарзА','рж╕ржкрзНрждржорзА','ржЕрж╖рзНржЯржорзА','ржиржмржорзА','ржжрж╢ржорзА','ржПржХрж╛ржжрж╢рзА','ржжрзНржмрж╛ржжрж╢рзА','рждрзНрж░ржпрж╝рзЛржжрж╢рзА','ржЪрждрзБрж░рзНржжрж╢рзА','ржЕржорж╛ржмрж╕рзНржпрж╛'];
  const tithi = tithiNames[(tithiNum-1)%30];

  // time remaining in current tithi (deg left / relative rate)
  const degInTithi = 12;
  const leftT = degInTithi - (elong % degInTithi);
  const relRate = 12.19075; // deg/day (Moon-Sun)
  const hrsLeft = leftT / relRate * 24;

  // nakshatra
  const span = 360/27; // 13┬░20тА▓
  const idx = Math.floor((moon)/span) % 27;
  const nak = NAK[idx];
  const degLeftNak = span - (moon % span);
  const moonRate = 13.176; // deg/day
  const hrsLeftNak = degLeftNak / moonRate * 24;

  return { tithi, tithiNum, tithiHrsLeft:hrsLeft.toFixed(1),
           nextTithi: tithiNames[(tithiNum)%30],
           nakshatra:nak, nakHrsLeft:hrsLeftNak.toFixed(1),
           nextNak: NAK[(idx+1)%27] };
}

function setPanchikaFromNow(){
  const d = new Date(); // current UTC-based calc
  const c = calcTithiNak(d);
  document.getElementById('tithi').textContent     = `${c.tithi} (тЙИ ${c.tithiHrsLeft} ржШржирзНржЯрж╛)`;
  document.getElementById('nakshatra').textContent = `${c.nakshatra} (тЙИ ${c.nakHrsLeft} ржШржирзНржЯрж╛)`;
}

/* =========================
   Next Ekadashi (live calc)
========================= */
function nextEkadashi(){
  // Search next 45 days; tithi at 06:00 local
  const base = new Date();
  for(let i=0;i<45;i++){
    const d = new Date(base.getTime()+i*86400000);
    d.setHours(6,0,0,0);
    const c = calcTithiNak(d);
    if(c.tithiNum===11 || c.tithiNum===26){
      const name = (c.tithiNum===11) ? 'рж╢рзБржХрзНрж▓ ржПржХрж╛ржжрж╢рзА' : 'ржХрзГрж╖рзНржг ржПржХрж╛ржжрж╢рзА';
      const dateISO = d.toISOString().slice(0,10);
      return {name, dateISO};
    }
  }
  return {name:'ржПржХрж╛ржжрж╢рзА', dateISO:null};
}
function renderEkadashi(obj){
  document.getElementById('ekaName').textContent = obj.name || 'ржПржХрж╛ржжрж╢рзА';
  if(!obj.dateISO){ document.getElementById('ekaSub').textContent='тАФ'; return; }
  const d = new Date(obj.dateISO+'T00:00:00');
  const days = Math.round((d - new Date(new Date().toDateString()))/86400000);
  const dt = d.toLocaleDateString('bn-IN',{year:'numeric',month:'long',day:'numeric'});
  document.getElementById('ekaSub').textContent = `${dt} ┬╖ ${days===0?'ржЖржЬ':(days>0?`${days} ржжрж┐ржи ржкрж░`:`${Math.abs(days)} ржжрж┐ржи ржЖржЧрзЗ`)}`;
}

/* =========================
   Popup handlers
========================= */
(function(){
  const open=document.getElementById('openPopup');
  const modal=document.getElementById('popup');
  const close=document.getElementById('closePopup');
  open.addEventListener('click',()=>modal.classList.add('active'));
  close.addEventListener('click',()=>modal.classList.remove('active'));
  modal.addEventListener('click',e=>{ if(e.target===modal) modal.classList.remove('active'); });
})();

/* =========================
   Boot
========================= */
(async function init(){
  const gps = await getGPS();
  if(gps){ GEO.lat=gps.lat; GEO.lon=gps.lon; } else {
    const ip = await getIP(); if(ip){ GEO.lat=ip.lat; GEO.lon=ip.lon; }
  }
  await loadSunMoon();              // live sun/moon times
  setPanchikaFromNow();             // live tithi/nakshatra (internal)
  renderEkadashi(nextEkadashi());   // live next Ekadashi (internal)

  // Refresh cycles
  setInterval(loadSunMoon, 3*60*60*1000);
  setInterval(setPanchikaFromNow, 60*60*1000);     // hourly refine
  setInterval(()=>renderEkadashi(nextEkadashi()), 6*60*60*1000);
})();
</script>

<!-- Inline netlify.toml (Netlify will pick this up) -->
<pre style="display:none">
[build]
  publish = "."
  command = ""

[build.environment]
  NODE_VERSION = "18"

[context.production.environment]
  TZ = "Asia/Kolkata"

[dev]
  command = "echo 'No build command needed'"
  port = 8888
  targetPort = 8888
  publish = "."
</pre>
</body>
</html>
